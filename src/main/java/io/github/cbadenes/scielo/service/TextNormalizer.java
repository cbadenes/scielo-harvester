package io.github.cbadenes.scielo.service;

import com.google.common.base.Strings;
import edu.stanford.nlp.ling.HasWord;
import edu.stanford.nlp.ling.SentenceUtils;
import edu.stanford.nlp.process.DocumentPreprocessor;
import org.apache.commons.text.StringEscapeUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.Reader;
import java.io.StringReader;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

/**
 * @author Badenes Olmedo, Carlos <cbadenes@fi.upm.es>
 */

public class TextNormalizer {

    private static final Logger LOG = LoggerFactory.getLogger(TextNormalizer.class);


    private static LanguageDetector languageDetector;

    static{
        languageDetector = new LanguageDetector();
    }

    public static String parse(String text, String language){
        if (Strings.isNullOrEmpty(text)) return "";
        return sentences(text).stream().filter(s -> !Strings.isNullOrEmpty(s)).filter(s -> languageDetector.isLanguage(language,s)).map(s -> normalize(s)).collect(Collectors.joining(" "));
    }

    public static List<String> sentences(String text){
        List<String> sentences = new ArrayList<>();

        Reader reader = new StringReader(StringEscapeUtils.unescapeHtml4(text));
        DocumentPreprocessor dp = new DocumentPreprocessor(reader);

        for (List<HasWord> sentence : dp) {
            // SentenceUtils not Sentence
            String sentenceString = SentenceUtils.listToString(sentence);
            sentences.add(sentenceString);
        }

        return sentences;
    }

    public static String parse(String text){
        if (Strings.isNullOrEmpty(text)) return "";
        return sentences(text).stream().map(s -> normalize(s)).collect(Collectors.joining(" "));
    }

    public static String normalize(String sentence){
        if (Strings.isNullOrEmpty(sentence)) return "";
        return removeParenthesis(sentence.trim().replaceAll("\\<.*?\\>","").replaceAll("\\&.*?\\;","").replaceAll("( )+", " ").replaceAll("-LSB-", "").replaceAll("-RSB","").replaceAll("-LRB-", "").replaceAll("-RRB-", ""),"[]");
    }

    public static String removeParenthesis(String input_string, String parenthesis_symbol){
        // removing parenthesis and everything inside them, works for (),[] and {}
        if(parenthesis_symbol.contains("[]")){
            return input_string.replaceAll("\\s*\\[[^\\]]*\\]\\s*", " ");
        }else if(parenthesis_symbol.contains("{}")){
            return input_string.replaceAll("\\s*\\{[^\\}]*\\}\\s*", " ");
        }else{
            return input_string.replaceAll("\\s*\\([^\\)]*\\)\\s*", " ");
        }
    }



    public static void main(String[] args) {
//        String text = "La atribuci&oacute;n de la guarda y custodia de menores est&aacute; determinada en la jurisprudencia espa&ntilde;ola por la supremac&iacute;a del Inter&eacute;s Superior del Menor (en adelante ISM), objetivo fundamental del Derecho de Familia, en correspondencia con el conjunto de instituciones y &aacute;mbitos en que su persona o patrimonio pueden ser afectados por medidas que otros tomen en su nombre (de Torres, 2011).";

        String text = "EDITORIAL The importance of clear methods descriptions in research papers Prof. Dr. Maria Müller-Staub Professor in Acute Care , Institute for Nursing & Master in Nursing Science , ZHAW University , Winterthur Switzerland The raising pressure on researchers to be `` productive '' has dramatically changed the research culture in the last decades . Historically , research environments allowed time to re-search , explore and develop knowledge for the sake of knowledge development and scientific discourse . Demands for constant fund seeking and expectations to gethigh citation indexes spur investigators to do `` fast-track research '' , that should be readily applied in the workplace . The length of papers has shortened , which spurs superficial reporting of studies . However , evidence-based nursing is importantto achieve high quality patient outcomes , and evidence relies on rigorous study designs being clearly described in research papers .  High research quality depends not only on unambiguous problem statements and clear research questions based on sound literature reviews . It is also crucial to reassure a good fit between research problem , research paradigm and methods .  A description of the theoretical framework guiding the study and unambiguous conceptual definitions of the concepts under investigation are critical to assure transparency and transferability -- even in quantitative studies .  To demonstrate application of ethical guidelines it 's not enough to just report ethics board approval . Moreover , the appropriateness of procedures used to safeguard study participants , e.g. what was done to reduce risks and maximize benefits of for theparticipants/subjects has to be explained in a paper .  The methods section should demonstrate the most rigorous possible design to achieve the study purpose . How about consistency between research question  s  , hypotheses , state of the art literature and the conceptual framework of the study ? Are hypotheses specific and clearly worded ? What are the key variables and do they match with the study population ? To ensure interpretabilityof study results , the readers must know if the methods and numbers of data collection points were appropriate in light of the research problem . Well-written research shows what was done to minimize bias or threats to internal , construct and external validity . What was the attrition rate ? Was blinding used ? And if : who or what was blinded ?  Sample-representativeness can be judged given the sampling strategy and procedures are highlighted , and if the participants/population is described in detail . Reporting the results of a power analysis is needed to judge the appropriateness of sample sizes and treatment effects .  When it comes to measurement , operationalization of variables , scoring procedures and reports about instruments - including results of psychometric testing - are important . How about the match between instrument choice with regard to the purpose , sample and context of the study ? What was done to reassure validity and reliability of measurements ? In diagnostic studies , reporting specificity and sensitivity information of instruments is important .  Generalizable intervention studies depend on specific descriptions of standardized study interventions : What was done , when , how often , by whom ? How was the intervention controlled to make sure it was performed equally and/or as outlined in the study proposal ? Was the researcher part of the intervention team ? How were persons trained to perform the intervention , and what was done to reduce bias ? In RCTs , best evidence relies on addressing all elements -- manipulation , randomization , control -- as equally important and by using appropriate statistical analyses .  The results section provides information on specific analyses used , such asstatistics and test methods . To demonstrate evidence of study findings , reporting the specific analysis methods applied including assumptions of statistical tests , significance levels , effect sizes and precision of estimates  confidence intervals  is crucial to substantiate the study results . Representativeness of tables and figures should be attentively reviewed . A sound research paper also transparently shows what was done to prevent Type I and II errors.Journal reviewers ask if risk adjustment measures were used to determine specific effects on patients , respectively on patient-groups . How about intention-to-treat analyses , and how were missing valueshandled ? Control of possible confounding factors and the reporting of their influence on outcome variables -- e.g. by using multi-level analyses , strengthens the main study results .  In summary , researchers and reviewers should ask : How well was validity established ? Does this study foster meta-analyses by providing in-depth information for further studies ? Why -- or why not -- do you have confidence in the truth-value of the study , and does it truly support evidence-based practice with meaningful results for patients and the nursing discipline ?  Polit DF , Beck CT. .  Nursing research . Generating and assessing evidence for nursing practice .  9 th ed . Philadelphia : Lippincott Williams 2012 .  EDITORIAL A importância da descrição clara dos métodos em artigos de pesquisa Prof. Dr. Maria Müller-Staub Professor in Acute Care , Institute for Nursing & Master in Nursing Science , ZHAW University , Winterthur Switzerland A crescente pressão sobre os investigadores para ser `` produtivo '' mudou radicalmente a cultura de pesquisa nas últimas décadas . Historicamente , ambientes de pesquisa permitia tempo para pesquisar , explorar e desenvolver o conhecimento pelo bem do desenvolvimento do conhecimento e do discurso científico . As demandas pela busca constante de doações ou outras fontes de fundos e expectativas de publicações em jornais de alto impacto levam os pesquisadores a `` pesquisas ultrarrápidas '' , que tem que ser aplicadas velozmente no local de trabalho . O tamanho dos artigos foi reduzido , determinando uma comunicação superficial dos estudos . Entretanto , a enfermagem baseada em evidências é importante para o alcance de resultados dos pacientes de alta qualidade , e as evidencias dependem de modelos de estudo rigorosos , claramente descritos em artigos de pesquisa .  Pesquisas de alta qualidade não dependem somente da formulação de problemas objetivos e questões claras de pesquisa , baseadas em revisões de literatura . É também fundamental assegurar conformidade entre o problema da pesquisa , paradigma de investigação e métodos . A descrição da estrutura teórica que orienta o estudo e definições conceituais claras dos conceitos a serem investigados são fundamentais para garantir a transparência e possibilidade de transmissibilidade - mesmo em estudos quantitativos .  Para demonstrar a aplicação de diretrizes éticas não é suficiente apenas o relatório de aprovação do comitê de ética . Mais do que isso , a utilização de procedimentos apropriados para proteção dos participantes do estudo , por exemplo , o que foi feito para reduzir os riscos e maximizar os benefícios para de os participantes / sujeitos tem que ser explicados no artigo .  A seção de métodos deve apresentar o mais rigorosamente possível o projeto para alcançar o objetivo do estudo .  Existe coerência entre a pergunta  s  de pesquisa , hipóteses , o estado da arte da literatura a estrutura conceitual do estudo ? As hipóteses são específicas e claramente formuladas ? Quais são as variáveis-chave e elas correspondem à população de estudo ? Para garantir compreensão dos resultados do estudo , os leitores devem saber se os métodos e números de coleta de dados foram adequados à luz do problema de pesquisa . Uma pesquisa bem escrita mostra o que foi feito para minimizar o viés ou ameaças à validade interna , de constructo e externa .  Qual foi a taxa de perdas ou desgaste ? Foram utilizadas as cegas ? E se foi : quem ou o que foi o cego ? Uma amostra de representatividade pode ser avaliada , conforme a estratégia de amostragem e os procedimentos são destacados , e se os participantes / população forem descritos em detalhes . A divulgação dos resultados de uma análise de força é necessária para avaliar a adequação das dimensões dos tamanhos das amostras e os efeitos do tratamento .  Quando se trata de medição , operacionalização de variáveis , procedimentos de pontuação e relatórios sobre instrumentos - incluindo resultados de testes psicométricos - são importantes . É possível a combinar o instrumento de escolha em relação a finalidade , amostra e contexto do estudo ? O que foi feito para assegurar validade e confiabilidade das medidas ? Em estudos diagnósticos , onde se relata especificidade e sensibilidade de informação instrumentos de informação é importante .  Estudos de intervenção dependem de descrições específicas de intervenções de estudos padronizados : O que foi feito , quando , como , muitas vezes , por quem ? Como a intervenção foi controlada para certificar-se que foi realizada de forma igual e / ou como foi descrita na proposta de estudo ? O pesquisador foi parte da equipe de intervenção ? Como as pessoas foram treinadas para realizar a intervenção , e o que foi feito para redução do viés ? Em estudos randômicos controlados , a melhor evidência depende da abordagem de todos os elementos - manipulação , randomização , controle - e o uso de análise estatística apropriada .  A seção de resultados fornece informações sobre as análises específicas utilizadas , como estatísticas e métodos de teste . Para demonstrar evidência dos resultados do estudo , relatando os métodos de análise específicos aplicados incluindo hipóteses de testes estatísticos , os níveis de significância , tamanhos de efeito e precisão das estimativas  intervalos de confiança  são fundamentais para justificar os resultados do estudo .  As representatividades das tabelas e figuras devem ser atentamente analisadas . Um trabalho de pesquisa criterioso e também transparente mostra o que foi feito para evitar erros Tipo I e II . Revisores de revista perguntam se as medidas de ajuste de risco foram usadas para determinar os efeitos específicos sobre os pacientes , respectivamente , em grupos-pacientes , e a intenção de tratar e como os valores perdidos são abordados ? Controlar as possíveis variáveis de confundimento e os relatórios de sua influência sobre as variáveis de desfecho - por exemplo , usando análise de multi-nível , para fortalecer os resultados do estudo principal .  Em resumo , os pesquisadores e revisores devem perguntar : Como foi estabelecida a validade ? Será que este estudo alimenta meta-análises , fornecendo informações detalhadas para estudos posteriores ? Por que você tem , ou não tem confiança no resultado do estudo , e ele realmente apoia a prática baseada em evidências com resultados significativos para os pacientes e a disciplina de enfermagem ?  REFERÊNCIAS EDITORIAL La importancia de las descripciones de métodos claras en los trabajos de investigación Prof. Dr. Maria Müller-Staub Profesora en Cuidados Intensivos ; Instituto de Enfermería y Máster en Ciencias de la Enfermería ; ZHAW University , Winterthur , Suiza La creciente presión sobre los investigadores para que sean `` productivos '' ha cambiado dramáticamente a la cultura de investigación en las últimas décadas . Históricamente , los ambientes de investigación permitían tiempo para re-investigar , explorar y desarrollar conocimiento por el bien del desarrollo del conocimiento y del discurso científico . La necesidad constante de búsqueda de costeos y expectativas de obtenerse altos índices de citación estimulan a los investigadores a hacer `` investigación relámpago '' , que debería aplicarse fácilmente en el lugar de trabajo . La duración de los trabajos se ha reducido , lo que estimula informes superficiales de los estudios . Sin embargo , la enfermería basada en la evidencia es importante para lograr una alta calidad en los resultados de los pacientes , y la evidencia se basa en rigurosos diseños de estudios claramente descritos en los trabajos de investigación .  La investigación de alta calidad depende no sólo de las afirmaciones sin ambigüedades de los problemas y preguntas de investigación claras basadas en revisiones bibliográficas detalladas . Es también esencial para asegurar un buen ajuste entre el problema de investigación , el paradigma de investigación y los métodos . Una descripción del marco teórico que guía el estudio y definiciones conceptuales sin ambigüedades de los conceptos que son objeto de la investigación son fundamentales para asegurar la transparencia y la transferibilidad - incluso en los estudios cuantitativos .  Sólo informar la aprobación del comité de ética no es suficiente para demostrar la aplicación de las directrices éticas . Es más , la adecuación de los procedimientos utilizados para salvaguardar los participantes del estudio , por ejemplo , qué se hizo para reducir los riesgos y maximizar los beneficios de los participantes/sujetos tiene que ser explicado en un trabajo .  La sección de métodos debe demostrar el diseño más riguroso posible para lograr el propósito del estudio . ¿ Qué hay de la coherencia entre la  s  pregunta  s  de investigación , hipótesis , bibliografía actual y el marco conceptual del estudio ? ¿ Las hipótesis se redactaron clara y específicamente ? ¿ Cuáles son las variables clave y ellas coinciden con la población de estudio ?  Para garantizar la interpretación de los resultados del estudio , los lectores deben saber si los métodos y el número de puntos de recolección de datos fueron los adecuados a la luz del problema de investigación . Las investigaciones bien escritas muestran lo que se fue hecho para minimizar el sesgo o las amenazas a la validez interna , de constructo y externa . ¿ Cuál fue la tasa de abandono ? ¿ Se utilizó el método de doble ciego ? Y , si se utilizó , ¿ quién o qué fue cegado ? La representatividad de la muestra se puede juzgar si se destacaron la estrategia de muestreo y procedimientos , y si se describen a los participantes/población en detalle . Se necesita el informe de los resultados de un análisis profundo y detallado para juzgar la adecuación de las muestras y de los efectos del tratamiento .  Cuando se trata de la medición , son importantes la puesta en marcha de variables , procedimientos de clasificación e informes sobre instrumentos , incluyéndose los resultados de las pruebas psicométricas . ¿ Y la combinación entre la elección de instrumentos con respecto del estudio ? ¿ Qué se hizo para asegurar la validez y la fiabilidad de las mediciones ? En los estudios de diagnóstico , es importante informar la especificidad y la sensibilidad de la información de los instrumentos .  Los estudios de intervención generalizables dependen de las descripciones específicas de las intervenciones de estudio estandarizadas : ¿ Qué se hizo , cuándo , con qué frecuencia , por quién ? ¿ Cómo fue controlada la intervención para asegurarse de que se realizó equitativamente y/o como indicado en la propuesta de estudio ? ¿ El investigador participó en el equipo de intervención ? ¿ Cómo se capacitaron a las personas para llevar a cabo la intervención , y qué se hizo para reducir el sesgo ? En las pruebas controladas aleatorias  RTC , en inglés  , la mejor evidencia se basa en abordar todos los elementos - la manipulación , la aleatorización , el control - como igualmente importantes y mediante el uso de análisis estadísticos apropiados .  La sección de resultados proporciona información sobre los análisis específicos utilizados , tales como estadísticas y métodos de ensayo . Para demostrar la evidencia de las conclusiones del estudio , es crucial informar los métodos de análisis específicos que se aplicaron , incluyendo las suposiciones de las pruebas estadísticas , niveles de significación , los tamaños del efecto y la precisión de las estimaciones  intervalos de confianza  para corroborar los resultados del estudio . La representatividad de las tablas y figuras deben ser atentamente revisadas . Un trabajo de investigación válido también muestra de forma transparente lo que se hizo para evitar errores de tipo I y II . Revisores de publicaciones médicas preguntan si medidas de ajuste de riesgo se utilizaron para determinar efectos específicos sobre los pacientes , respectivamente , en los grupos de pacientes . ¿ Y en relación al análisis de la intención de tratamiento , cómo se manejaron los valores faltantes ? El control de los posibles factores de confusión e informar su influencia sobre las variables de los resultados - por ejemplo , reforzar los principales resultados del estudio mediante el uso de análisis multinivel .  En resumen , los investigadores y los revisores deben preguntarse : ¿ Qué tan bien se establece la validez ? ¿ Este estudio fomenta la meta-análisis al proporcionar información en profundidad para la realización de estudios adicionales ? ¿ Por qué - o por qué no - tiene usted confianza en el valor de verdad del estudio , y el realmente apoya la práctica basada en la evidencia con resultados significativos para los pacientes y la disciplina de enfermería ?  Polit DF , Beck CT. .  Nursing research . Generating and assessing evidence for nursing practice .  9 th ed . Philadelphia : Lippincott Williams 2012 . ";


        LOG.info(TextNormalizer.parse(text,"en"));

//
//        LOG.info(StringEscapeUtils.unescapeJava(text));
//        LOG.info(StringEscapeUtils.unescapeCsv(text));
//        LOG.info(StringEscapeUtils.unescapeXml(text));
//        LOG.info(StringEscapeUtils.unescapeHtml3(text));
//        LOG.info(StringEscapeUtils.unescapeHtml4(text));
    }

}
